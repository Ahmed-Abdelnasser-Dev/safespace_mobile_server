generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum AccidentSource {
  MOBILE
  CENTRAL_UNIT
}

enum EmergencyRequestStatus {
  QUEUED
  SENT
  FAILED
}

enum EmergencyType {
  CAR_ACCIDENT
  MEDICAL_EMERGENCY
  FIRE
  CRIME_VIOLENCE
  VEHICLE_BREAKDOWN
  OTHER
}

enum EmergencyService {
  POLICE
  AMBULANCE
  FIRE_DEPARTMENT
  ROADSIDE_ASSISTANCE
}

model User {
  id           String   @id @default(uuid())
  email        String   @unique
  passwordHash String?
  fullName     String
  phone        String?
  role         String   @default("USER")
  
  // Email verification
  emailVerified            Boolean   @default(false)
  emailVerificationToken   String?   @unique
  emailVerificationExpires DateTime?
  
  // Account security
  accountLockedUntil DateTime?
  
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Personal Information
  displayName       String?
  profilePictureUrl String?
  phoneNumber       String?
  country           String?
  city              String?
  address           String?

  // Medical Information
  bloodType           String?
  allergies           String[] // Array of allergy strings
  chronicConditions   String[] // Array of chronic conditions
  currentMedications  String[] // Array of current medications
  disabilities        String[] // Array of disabilities
  medicalNotes        String?  // Free-form medical notes
  heightCm            Float?
  weightKg            Float?
  smoker              Boolean?
  lastUpdatedAt       DateTime?

  // Identification Data
  fullLegalName            String?
  dateOfBirth              DateTime?
  gender                   String?
  nationality              String?
  nationalIdNumber         String?
  passportNumber           String?
  emergencyContactName     String?
  emergencyContactPhone    String?
  emergencyContactRelation String?
  verifiedAt               DateTime?

  accidents        Accident[]
  emergencyRequests EmergencyRequest[]
  sessions         Session[]
  loginAttempts    LoginAttempt[]
}

model Session {
  id               String   @id @default(uuid())
  userId           String
  deviceId         String?
  fcmToken         String?
  refreshTokenHash String
  revokedAt        DateTime?
  expiresAt        DateTime
  createdAt        DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model Accident {
  id                     String        @id @default(uuid())
  reporterUserId         String?
  source                 AccidentSource
  occurredAt             DateTime
  lat                    Float
  lng                    Float
  message                String?
  description            String?
  severity               String?
  centralUnitAccidentId  String?
  centralUnitReferenceId String?
  status                 String        @default("RECEIVED")
  createdAt              DateTime      @default(now())
  updatedAt              DateTime      @updatedAt

  reporter User?          @relation(fields: [reporterUserId], references: [id], onDelete: SetNull)
  media    AccidentMedia[]

  @@index([reporterUserId])
  @@index([createdAt])
  @@index([centralUnitAccidentId])
}

model AccidentMedia {
  id         String   @id @default(uuid())
  accidentId String
  type       String
  url        String
  createdAt  DateTime @default(now())

  accident Accident @relation(fields: [accidentId], references: [id], onDelete: Cascade)

  @@index([accidentId])
}

model EmergencyRequest {
  id                String                 @id @default(uuid())
  requesterUserId   String?
  emergencyTypes    EmergencyType[]
  emergencyServices EmergencyService[]
  description       String
  photoUri          String?
  lat               Float
  lng               Float
  timestamp         DateTime               @default(now())
  status            EmergencyRequestStatus @default(QUEUED)
  createdAt         DateTime               @default(now())
  updatedAt         DateTime               @updatedAt

  requester User? @relation(fields: [requesterUserId], references: [id], onDelete: SetNull)

  @@index([requesterUserId])
  @@index([createdAt])
  @@index([timestamp])
}

model NotificationLog {
  id        String   @id @default(uuid())
  accidentId String?
  userId    String?
  provider  String
  status    String
  error     String?
  createdAt DateTime @default(now())

  @@index([accidentId])
  @@index([userId])
  @@index([createdAt])
}

model LoginAttempt {
  id         String   @id @default(uuid())
  userId     String?
  email      String
  ipAddress  String
  userAgent  String?
  successful Boolean  @default(false)
  createdAt  DateTime @default(now())

  user User? @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([email, createdAt])
  @@index([userId])
  @@index([ipAddress])
}

